{% extends 'base.html' %}

{% block title %}Registrar Usuario - ServiHogar{% endblock %}

{% block content %}
<div class="form-container">
    <div class="form-header">
        <h1>Registrar Nuevo Usuario</h1>
        <p>Complete el formulario para dar de alta a un nuevo cliente o profesional</p>
    </div>
    
    <form method="post" enctype="multipart/form-data" class="form-card" id="registroForm">
        {% csrf_token %}
        
        <div class="form-section">
            <h3>Información Básica</h3>
            
            <div class="form-group">
                <label for="{{ form.username.id_for_label }}">{{ form.username.label }} *</label>
                {{ form.username }}
                {% if form.username.errors %}
                    <div class="error-message">{{ form.username.errors.0 }}</div>
                {% endif %}
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.first_name.id_for_label }}">{{ form.first_name.label }} *</label>
                    {{ form.first_name }}
                    {% if form.first_name.errors %}
                        <div class="error-message">{{ form.first_name.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.last_name.id_for_label }}">{{ form.last_name.label }} *</label>
                    {{ form.last_name }}
                    {% if form.last_name.errors %}
                        <div class="error-message">{{ form.last_name.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-group">
                <label for="{{ form.email.id_for_label }}">{{ form.email.label }} *</label>
                {{ form.email }}
                {% if form.email.errors %}
                    <div class="error-message">{{ form.email.errors.0 }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.rol.id_for_label }}">{{ form.rol.label }} *</label>
                {{ form.rol }}
                {% if form.rol.errors %}
                    <div class="error-message">{{ form.rol.errors.0 }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="form-section">
            <h3>Contraseña</h3>
            
            <div class="form-group">
                <label for="{{ form.password1.id_for_label }}">{{ form.password1.label }} *</label>
                {{ form.password1 }}
                {% if form.password1.errors %}
                    <div class="error-message">{{ form.password1.errors.0 }}</div>
                {% endif %}
                <small class="form-help">{{ form.password1.help_text }}</small>
            </div>
            
            <div class="form-group">
                <label for="{{ form.password2.id_for_label }}">{{ form.password2.label }} *</label>
                {{ form.password2 }}
                {% if form.password2.errors %}
                    <div class="error-message">{{ form.password2.errors.0 }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="form-section">
            <h3>Información de Contacto</h3>
            
            <div class="form-group">
                <label for="{{ form.telefono.id_for_label }}">{{ form.telefono.label }}</label>
                {{ form.telefono }}
                {% if form.telefono.errors %}
                    <div class="error-message">{{ form.telefono.errors.0 }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.direccion.id_for_label }}">{{ form.direccion.label }}</label>
                {{ form.direccion }}
                {% if form.direccion.errors %}
                    <div class="error-message">{{ form.direccion.errors.0 }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.foto_perfil.id_for_label }}">{{ form.foto_perfil.label }}</label>
                {{ form.foto_perfil }}
                {% if form.foto_perfil.errors %}
                    <div class="error-message">{{ form.foto_perfil.errors.0 }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="form-section" id="profesionalFields" style="display: none;">
            <h3>Configuración de Profesional</h3>
            
            <!-- Años de experiencia -->
            <div class="form-group">
                <label for="{{ form.anios_experiencia.id_for_label }}">Años de experiencia</label>
                {{ form.anios_experiencia }}
                {% if form.anios_experiencia.errors %}
                    <div class="error-message">{{ form.anios_experiencia.errors.0 }}</div>
                {% endif %}
                <small class="form-help">{{ form.anios_experiencia.help_text }}</small>
            </div>
            
            <!-- Selección de servicios -->
            <div class="form-group">
                <label class="section-label">Servicios que ofrece</label>
                <div class="servicios-grid">
                    {% for servicio in servicios_disponibles %}
                    <div class="servicio-card">
                        <div class="servicio-header">
                            <input type="checkbox" name="servicios" value="{{ servicio.id }}" id="servicio_{{ servicio.id }}">
                            <label for="servicio_{{ servicio.id }}">{{ servicio.nombre }}</label>
                        </div>
                        <div class="servicio-details">
                            <span class="badge-categoria">{{ servicio.categoria.nombre }}</span>
                            <p class="servicio-descripcion">{{ servicio.descripcion }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Horarios de disponibilidad -->
            <div class="form-group">
                <label class="section-label">Horarios de Disponibilidad</label>
                <div id="horarios-container">
                    <!-- Se llenarán dinámicamente con JavaScript -->
                </div>
                <button type="button" id="add-horario" class="btn btn-secondary">
                    <span>+</span> Agregar Horario
                </button>
            </div>
            
            <!-- Campo oculto para horarios JSON -->
            <input type="hidden" name="horarios_json" id="horarios_json">
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Registrar Usuario</button>
            <a href="{% url 'usuarios:buscar_usuario' %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

<script>
// Mostrar/ocultar campos de profesional según el rol seleccionado
document.addEventListener('DOMContentLoaded', function() {
    const rolSelect = document.getElementById('id_rol');
    const profesionalFields = document.getElementById('profesionalFields');
    
    function toggleProfesionalFields() {
        if (rolSelect.value === 'profesional') {
            profesionalFields.style.display = 'block';
        } else {
            profesionalFields.style.display = 'none';
        }
    }
    
    rolSelect.addEventListener('change', toggleProfesionalFields);
    toggleProfesionalFields(); // Ejecutar al cargar
    
    // ===== GESTIÓN DE HORARIOS =====
    const horariosContainer = document.getElementById('horarios-container');
    const addHorarioBtn = document.getElementById('add-horario');
    const horariosJsonInput = document.getElementById('horarios_json');
    
    let horarios = [];
    
    function renderHorarios() {
        horariosContainer.innerHTML = '';
        horarios.forEach((horario, index) => {
            const row = document.createElement('div');
            row.className = 'horario-row';
            row.innerHTML = `
                <select class="dia-select" required>
                    <option value="">Seleccionar día</option>
                    <option value="lunes" ${horario.dia === 'lunes' ? 'selected' : ''}>Lunes</option>
                    <option value="martes" ${horario.dia === 'martes' ? 'selected' : ''}>Martes</option>
                    <option value="miercoles" ${horario.dia === 'miercoles' ? 'selected' : ''}>Miércoles</option>
                    <option value="jueves" ${horario.dia === 'jueves' ? 'selected' : ''}>Jueves</option>
                    <option value="viernes" ${horario.dia === 'viernes' ? 'selected' : ''}>Viernes</option>
                    <option value="sabado" ${horario.dia === 'sabado' ? 'selected' : ''}>Sábado</option>
                    <option value="domingo" ${horario.dia === 'domingo' ? 'selected' : ''}>Domingo</option>
                </select>
                <input type="time" class="hora-inicio" value="${horario.hora_inicio}" required>
                <input type="time" class="hora-fin" value="${horario.hora_fin}" required>
                <button type="button" class="btn-remove-horario">✕</button>
            `;
            
            // Event listeners
            row.querySelector('.dia-select').addEventListener('change', (e) => {
                horarios[index].dia = e.target.value;
                updateHorariosJson();
            });
            row.querySelector('.hora-inicio').addEventListener('change', (e) => {
                horarios[index].hora_inicio = e.target.value;
                updateHorariosJson();
            });
            row.querySelector('.hora-fin').addEventListener('change', (e) => {
                horarios[index].hora_fin = e.target.value;
                updateHorariosJson();
            });
            row.querySelector('.btn-remove-horario').addEventListener('click', () => {
                horarios.splice(index, 1);
                renderHorarios();
                updateHorariosJson();
            });
            
            horariosContainer.appendChild(row);
        });
    }
    
    function updateHorariosJson() {
        horariosJsonInput.value = JSON.stringify(horarios);
    }
    
    addHorarioBtn.addEventListener('click', () => {
        horarios.push({
            dia: '',
            hora_inicio: '',
            hora_fin: ''
        });
        renderHorarios();
    });
    
    // Validación de formulario
    document.getElementById('registroForm').addEventListener('submit', function(e) {
        if (rolSelect.value === 'profesional') {
            // Validar horarios
            let valid = true;
            let errorMessage = '';
            
            horarios.forEach((h, i) => {
                if (!h.dia || !h.hora_inicio || !h.hora_fin) {
                    valid = false;
                    errorMessage = 'Complete todos los campos de los horarios';
                } else if (h.hora_fin <= h.hora_inicio) {
                    valid = false;
                    errorMessage = 'La hora de fin debe ser mayor a la hora de inicio';
                }
            });
            
            if (!valid) {
                e.preventDefault();
                alert(errorMessage);
                return false;
            }
        }
    });
});
</script>

<style>
.form-container {
    max-width: 800px;
    margin: 2rem auto;
    padding: 2rem;
}

.form-header {
    text-align: center;
    margin-bottom: 2rem;
}

.form-header h1 {
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.form-header p {
    color: #666;
}

.form-card {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.form-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #eee;
}

.form-section:last-of-type {
    border-bottom: none;
}

.form-section h3 {
    color: #2c3e50;
    margin-bottom: 1rem;
    font-size: 1.2rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: #2c3e50;
    font-weight: 500;
}

.form-group input[type="text"],
.form-group input[type="email"],
.form-group input[type="password"],
.form-group input[type="number"],
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 1rem;
}

.form-group textarea {
    resize: vertical;
}

.form-help {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.875rem;
    color: #666;
}

.error-message {
    color: #e74c3c;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
}

/* Estilos de servicios - Grid moderno */
.servicios-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.servicio-card {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    transition: all 0.2s;
}

.servicio-card:has(input:checked) {
    background: #e7f3ff;
    border-color: #17a2b8;
}

.servicio-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.servicio-header input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.servicio-header label {
    font-weight: 600;
    color: #2c3e50;
    cursor: pointer;
    margin: 0;
}

.servicio-details {
    margin-left: 1.5rem;
}

.badge-categoria {
    display: inline-block;
    background: #17a2b8;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    margin-bottom: 0.5rem;
}

.servicio-descripcion {
    font-size: 0.85rem;
    color: #666;
    margin: 0;
}

/* Estilos de horarios */
.horario-row {
    display: grid;
    grid-template-columns: 2fr 1.5fr 1.5fr auto;
    gap: 0.75rem;
    align-items: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 0.75rem;
    border: 1px solid #dee2e6;
}

.dia-select,
.hora-inicio,
.hora-fin {
    padding: 0.6rem;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 0.95rem;
}

.btn-remove-horario {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0.6rem 0.8rem;
    cursor: pointer;
    font-size: 1.2rem;
    transition: background 0.2s;
}

.btn-remove-horario:hover {
    background: #c82333;
}

.btn-secondary {
    background: #6c757d;
    color: white;
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: background 0.2s;
    margin-top: 0.5rem;
}

.btn-secondary:hover {
    background: #5a6268;
}

.section-label {
    display: block;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .form-container {
        padding: 1rem;
    }
    
    .servicios-grid {
        grid-template-columns: 1fr;
    }
    
    .horario-row {
        grid-template-columns: 1fr;
        gap: 0.5rem;
    }
}
</style>
{% endblock %}
