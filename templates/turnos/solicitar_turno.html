{% extends 'base.html' %}
{% load static %}

{% block title %}Solicitar Turno - ServiHogar{% endblock %}

{% block extra_css %}
<style>
.solicitar-turno-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.paso {
    background: white;
    padding: 25px;
    margin-bottom: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.paso-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #3498db;
}

.paso-numero {
    width: 40px;
    height: 40px;
    background: #3498db;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2em;
}

.paso-titulo {
    font-size: 1.4em;
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
}

/* Servicios grid */
.servicios-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.servicio-card {
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s;
    background: white;
}

.servicio-card:hover {
    border-color: #3498db;
    box-shadow: 0 4px 8px rgba(52, 152, 219, 0.2);
    transform: translateY(-2px);
}

.servicio-card.seleccionado {
    border-color: #3498db;
    background: #e8f4fd;
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
}

.servicio-nombre {
    font-weight: 600;
    font-size: 1.1em;
    color: #2c3e50;
    margin-bottom: 8px;
}

.servicio-descripcion {
    color: #666;
    font-size: 0.95em;
    margin-bottom: 10px;
    line-height: 1.4;
}

.servicio-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 10px;
    border-top: 1px solid #e0e0e0;
}

.servicio-precio {
    font-weight: 600;
    color: #27ae60;
    font-size: 1.2em;
}

.servicio-duracion {
    color: #666;
    font-size: 0.9em;
}

/* Profesionales y horarios */
.profesional-item {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.profesional-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 2px solid #3498db;
}

.profesional-foto {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #3498db;
}

.profesional-placeholder {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #3498db;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.5em;
}

.profesional-info {
    flex: 1;
}

.profesional-nombre {
    font-weight: 600;
    font-size: 1.2em;
    color: #2c3e50;
    margin-bottom: 5px;
}

.profesional-meta {
    display: flex;
    gap: 15px;
    color: #666;
    font-size: 0.95em;
}

.horarios-scroll {
    display: flex;
    gap: 10px;
    padding: 10px 0;
    overflow-x: auto;
}

.horario-slot {
    min-width: 150px;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    padding: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: white;
}

.horario-slot:hover {
    border-color: #3498db;
    background: #f0f8ff;
}

.horario-slot.seleccionado {
    border-color: #27ae60;
    background: #d4edda;
    box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
}

.horario-fecha {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 5px;
}

.horario-dia {
    font-size: 0.85em;
    color: #666;
    margin-bottom: 5px;
}

.horario-hora {
    font-size: 1.1em;
    color: #3498db;
    font-weight: 600;
    margin-bottom: 5px;
}

.horario-precio {
    font-weight: 600;
    color: #27ae60;
}

#map {
    width: 100%;
    height: 400px;
    border-radius: 8px;
    margin-bottom: 15px;
    border: 2px solid #e0e0e0;
}

.resumen-seleccion {
    background: #e8f4fd;
    border: 2px solid #3498db;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    display: none;
}

.resumen-seleccion.visible {
    display: block;
}

.resumen-titulo {
    font-weight: 600;
    font-size: 1.2em;
    color: #2c3e50;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #3498db;
}

.resumen-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #d0e8f5;
}

.resumen-label {
    font-weight: 600;
    color: #555;
}

.resumen-valor {
    color: #2c3e50;
}

.mensaje-info {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 6px;
    padding: 15px;
    margin-top: 15px;
    color: #856404;
}

.mensaje-vacio {
    text-align: center;
    padding: 40px;
    color: #666;
    font-size: 1.1em;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #666;
}

/* Estilos para Promociones */
.promociones-section {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border: 2px solid #3498db;
    border-radius: 12px;
    padding: 20px;
}

.promocion-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    color: #2c3e50;
}

.promocion-header i {
    font-size: 1.5em;
    color: #3498db;
}

.promocion-header h3 {
    margin: 0;
    font-size: 1.3em;
    font-weight: 600;
}

.promocion-card {
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s;
}

.promocion-card:hover {
    border-color: #3498db;
    box-shadow: 0 4px 8px rgba(52, 152, 219, 0.2);
    transform: translateX(5px);
}

.promocion-card.seleccionada {
    border-color: #27ae60;
    background: #d4edda;
    box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
}

.promocion-titulo {
    font-weight: 600;
    font-size: 1.1em;
    color: #2c3e50;
    margin-bottom: 5px;
}

.promocion-descripcion {
    color: #666;
    font-size: 0.95em;
    margin-bottom: 10px;
}

.promocion-detalles {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 10px;
    border-top: 1px solid #e0e0e0;
}

.promocion-descuento {
    background: #27ae60;
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.95em;
}

.promocion-precio {
    font-size: 1.1em;
}

.precio-tachado {
    text-decoration: line-through;
    color: #999;
    margin-right: 5px;
}

.precio-final {
    color: #27ae60;
    font-weight: 600;
    font-size: 1.2em;
}

#mensaje-codigo {
    padding: 10px;
    border-radius: 6px;
}

#mensaje-codigo.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

#mensaje-codigo.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
</style>
{% endblock %}

{% block content %}
<div class="solicitar-turno-container">
    <h1>Solicitar Turno</h1>
    
    <form method="post" id="turnoForm">
        {% csrf_token %}
        
        <!-- Paso 1: Seleccionar Categor√≠a y Servicio -->
        <div class="paso" id="paso1">
            <div class="paso-header">
                <div class="paso-numero">1</div>
                <h2 class="paso-titulo">Seleccione el Servicio</h2>
            </div>
            
            <div class="form-group">
                <label for="id_categoria">Categor√≠a:</label>
                {{ form.categoria }}
            </div>
            
            <div id="servicios-container">
                <div class="mensaje-vacio">Seleccione una categor√≠a para ver los servicios disponibles</div>
            </div>
        </div>
        
        <!-- Paso 2: Seleccionar Profesional y Horario -->
        <div class="paso" id="paso2" style="display: none;">
            <div class="paso-header">
                <div class="paso-numero">2</div>
                <h2 class="paso-titulo">Seleccione Fecha y Hora</h2>
            </div>
            
            <div id="grilla-disponibilidad">
                <div class="loading">Cargando disponibilidad...</div>
            </div>
        </div>
        
        <!-- Paso 3: Ubicaci√≥n y Observaciones -->
        <div class="paso" id="paso3" style="display: none;">
            <div class="paso-header">
                <div class="paso-numero">3</div>
                <h2 class="paso-titulo">Ubicaci√≥n y Detalles</h2>
            </div>
            
            <!-- Resumen -->
            <div class="resumen-seleccion" id="resumen">
                <div class="resumen-titulo">Resumen de tu solicitud</div>
                <div class="resumen-item">
                    <span class="resumen-label">Servicio:</span>
                    <span class="resumen-valor" id="resumen-servicio">-</span>
                </div>
                <div class="resumen-item">
                    <span class="resumen-label">Profesional:</span>
                    <span class="resumen-valor" id="resumen-profesional">-</span>
                </div>
                <div class="resumen-item">
                    <span class="resumen-label">Fecha:</span>
                    <span class="resumen-valor" id="resumen-fecha">-</span>
                </div>
                <div class="resumen-item">
                    <span class="resumen-label">Hora:</span>
                    <span class="resumen-valor" id="resumen-hora">-</span>
                </div>
                <div class="resumen-item">
                    <span class="resumen-label">Precio Base:</span>
                    <span class="resumen-valor" id="resumen-precio">-</span>
                </div>
                <div class="resumen-item" id="resumen-descuento-item" style="display: none;">
                    <span class="resumen-label" style="color: #27ae60;">Descuento:</span>
                    <span class="resumen-valor" style="color: #27ae60; font-weight: bold;" id="resumen-descuento">-</span>
                </div>
                <div class="resumen-item" id="resumen-total-item" style="display: none;">
                    <span class="resumen-label" style="font-size: 1.2em; font-weight: bold;">Total a Pagar:</span>
                    <span class="resumen-valor" style="font-size: 1.2em; font-weight: bold; color: #2980b9;" id="resumen-total">-</span>
                </div>
            </div>
            
            <!-- Secci√≥n de Promociones -->
            <div class="promociones-section" id="promociones-section" style="display: none; margin-top: 20px;">
                <div class="promocion-header">
                    <i class="fas fa-tags"></i>
                    <h3>¬øTen√©s una promoci√≥n?</h3>
                </div>
                
                <!-- C√≥digo promocional -->
                <div class="form-group">
                    <label for="{{ form.codigo_promocion.id_for_label }}">
                        <i class="fas fa-ticket-alt"></i> {{ form.codigo_promocion.label }}
                    </label>
                    <div style="display: flex; gap: 10px;">
                        {{ form.codigo_promocion }}
                        <button type="button" class="btn btn-info" id="btnValidarCodigo" style="white-space: nowrap;">
                            <i class="fas fa-check"></i> Validar
                        </button>
                    </div>
                    <small class="form-text text-muted">{{ form.codigo_promocion.help_text }}</small>
                    <div id="mensaje-codigo" style="margin-top: 10px;"></div>
                </div>
                
                <!-- Promociones disponibles -->
                <div class="form-group" id="promociones-disponibles-group" style="display: none;">
                    <label for="{{ form.promocion.id_for_label }}">
                        <i class="fas fa-percentage"></i> {{ form.promocion.label }}
                    </label>
                    {{ form.promocion }}
                    <small class="form-text text-muted">{{ form.promocion.help_text }}</small>
                </div>
                
                <!-- Lista de promociones disponibles (visual) -->
                <div id="lista-promociones" style="margin-top: 15px;"></div>
            </div>
            
            <div class="form-group">
                <label>Seleccionar ubicaci√≥n en el mapa:</label>
                <div id="map"></div>
                <input type="hidden" id="latitud" name="latitud">
                <input type="hidden" id="longitud" name="longitud">
            </div>
            
            <div class="form-group">
                <label for="{{ form.direccion_servicio.id_for_label }}">{{ form.direccion_servicio.label }}:</label>
                {{ form.direccion_servicio }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.observaciones.id_for_label }}">{{ form.observaciones.label }}:</label>
                {{ form.observaciones }}
            </div>
            
            <div class="mensaje-info">
                <strong>Nota:</strong> El profesional revisar√° tu solicitud y podr√° confirmarla o rechazarla.
            </div>
        </div>
        
        <!-- Campos ocultos -->
        <input type="hidden" id="servicio_id" name="servicio_id">
        <input type="hidden" id="profesional_id" name="profesional_id">
        <input type="hidden" id="fecha" name="fecha">
        <input type="hidden" id="hora" name="hora">
        
        <div class="form-actions">
            <a href="{% url 'usuarios:dashboard_cliente' %}" class="btn btn-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary" id="btnSolicitar" disabled>Solicitar Turno</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
let map, marker, geocoder;
let servicioSeleccionado = null;
let profesionalSeleccionado = null;
let horarioSeleccionado = null;

function initMap() {
    const defaultLocation = { lat: -34.6037, lng: -58.3816 };
    
    map = new google.maps.Map(document.getElementById('map'), {
        center: defaultLocation,
        zoom: 13
    });
    
    geocoder = new google.maps.Geocoder();
    
    marker = new google.maps.Marker({
        map: map,
        draggable: true,
        position: defaultLocation
    });
    
    google.maps.event.addListener(marker, 'dragend', function() {
        const position = marker.getPosition();
        document.getElementById('latitud').value = position.lat();
        document.getElementById('longitud').value = position.lng();
        obtenerDireccion(position.lat(), position.lng());
    });
    
    map.addListener('click', function(event) {
        marker.setPosition(event.latLng);
        document.getElementById('latitud').value = event.latLng.lat();
        document.getElementById('longitud').value = event.latLng.lng();
        obtenerDireccion(event.latLng.lat(), event.latLng.lng());
    });
}

function obtenerDireccion(lat, lng) {
    const latlng = { lat: parseFloat(lat), lng: parseFloat(lng) };
    geocoder.geocode({ location: latlng }, (results, status) => {
        if (status === 'OK' && results[0]) {
            document.getElementById('id_direccion').value = results[0].formatted_address;
        }
    });
}

document.getElementById('id_categoria').addEventListener('change', function() {
    const categoriaId = this.value;
    const container = document.getElementById('servicios-container');
    
    if (!categoriaId) {
        container.innerHTML = '<div class="mensaje-vacio">Seleccione una categor√≠a</div>';
        document.getElementById('paso2').style.display = 'none';
        document.getElementById('paso3').style.display = 'none';
        return;
    }
    
    container.innerHTML = '<div class="loading">Cargando servicios...</div>';
    
    fetch(`/turnos/api/servicios-por-categoria/?categoria_id=${categoriaId}`)
        .then(response => response.json())
        .then(data => {
            if (data.servicios.length === 0) {
                container.innerHTML = '<div class="mensaje-vacio">No hay servicios disponibles</div>';
                return;
            }
            
            let html = '<div class="servicios-grid">';
            data.servicios.forEach(servicio => {
                html += `
                    <div class="servicio-card" data-servicio-id="${servicio.id}" data-servicio-nombre="${servicio.nombre}" data-servicio-precio="${servicio.precio_base}">
                        <div class="servicio-nombre">${servicio.nombre}</div>
                        <div class="servicio-descripcion">${servicio.descripcion}</div>
                        <div class="servicio-info">
                            <span class="servicio-precio">$${servicio.precio_base}</span>
                            <span class="servicio-duracion">‚è±Ô∏è ${servicio.duracion_estimada} min</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
            
            document.querySelectorAll('.servicio-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.servicio-card').forEach(c => c.classList.remove('seleccionado'));
                    this.classList.add('seleccionado');
                    
                    servicioSeleccionado = {
                        id: this.dataset.servicioId,
                        nombre: this.dataset.servicioNombre,
                        precio: this.dataset.servicioPrecio
                    };
                    
                    document.getElementById('servicio_id').value = servicioSeleccionado.id;
                    cargarProfesionales(servicioSeleccionado.id);
                    document.getElementById('paso2').style.display = 'block';
                    document.getElementById('paso2').scrollIntoView({ behavior: 'smooth' });
                });
            });
        });
});

function cargarProfesionales(servicioId) {
    // Esto hay que arreglar. La API esta no est√° funcionadno. Cambiar y, si se puede, sacar 
    const container = document.getElementById('grilla-disponibilidad');
    container.innerHTML = '<div class="loading">Cargando disponibilidad...</div>';
    
    fetch(`/turnos/api/profesionales-disponibles/?servicio_id=${servicioId}`)
        .then(response => response.json())
        .then(data => {
            if (data.profesionales.length === 0) {
                container.innerHTML = '<div class="mensaje-vacio">No hay profesionales disponibles</div>';
                return;
            }
            
            let html = '';
            data.profesionales.forEach(profesional => {
                html += `
                    <div class="profesional-item">
                        <div class="profesional-header">
                            ${profesional.foto ? 
                                `<img src="${profesional.foto}" alt="${profesional.nombre}" class="profesional-foto">` :
                                `<div class="profesional-placeholder">${profesional.nombre.charAt(0)}</div>`
                            }
                            <div class="profesional-info">
                                <div class="profesional-nombre">${profesional.nombre}</div>
                                <div class="profesional-meta">
                                    <span>‚≠ê ${profesional.calificacion.toFixed(1)}</span>
                                    <span>üìÖ ${profesional.experiencia} a√±os</span>
                                </div>
                            </div>
                        </div>
                        <div class="horarios-scroll">
                `;
                
                profesional.disponibilidad.forEach(slot => {
                    html += `
                        <div class="horario-slot" 
                             data-profesional-id="${profesional.id}"
                             data-profesional-nombre="${profesional.nombre}"
                             data-fecha="${slot.fecha}"
                             data-hora="${slot.hora}"
                             data-precio="${slot.precio}">
                            <div class="horario-fecha">${slot.fecha_formato}</div>
                            <div class="horario-dia">${slot.dia_semana}</div>
                            <div class="horario-hora">${slot.hora}</div>
                            <div class="horario-precio">$${slot.precio}</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            document.querySelectorAll('.horario-slot').forEach(slot => {
                slot.addEventListener('click', function() {
                    document.querySelectorAll('.horario-slot').forEach(s => s.classList.remove('seleccionado'));
                    this.classList.add('seleccionado');
                    
                    profesionalSeleccionado = {
                        id: this.dataset.profesionalId,
                        nombre: this.dataset.profesionalNombre
                    };
                    
                    horarioSeleccionado = {
                        fecha: this.dataset.fecha,
                        hora: this.dataset.hora,
                        precio: this.dataset.precio
                    };
                    
                    document.getElementById('profesional_id').value = profesionalSeleccionado.id;
                    document.getElementById('fecha').value = horarioSeleccionado.fecha;
                    document.getElementById('hora').value = horarioSeleccionado.hora;
                    
                    actualizarResumen();
                    document.getElementById('paso3').style.display = 'block';
                    document.getElementById('resumen').classList.add('visible');
                    document.getElementById('paso3').scrollIntoView({ behavior: 'smooth' });
                    document.getElementById('btnSolicitar').disabled = false;
                });
            });
        });
}

function actualizarResumen() {
    document.getElementById('resumen-servicio').textContent = servicioSeleccionado.nombre;
    document.getElementById('resumen-profesional').textContent = profesionalSeleccionado.nombre;
    document.getElementById('resumen-fecha').textContent = horarioSeleccionado.fecha;
    document.getElementById('resumen-hora').textContent = horarioSeleccionado.hora;
    document.getElementById('resumen-precio').textContent = `$${horarioSeleccionado.precio}`;
    
    // Cargar promociones disponibles
    cargarPromocionesDisponibles();
}

let promocionesDisponibles = [];
let precioBase = 0;

function cargarPromocionesDisponibles() {
    if (!servicioSeleccionado) return;
    
    precioBase = parseFloat(horarioSeleccionado.precio);
    
    fetch(`{% url 'turnos:promociones_disponibles' %}?servicio_id=${servicioSeleccionado.id}`)
        .then(response => response.json())
        .then(data => {
            promocionesDisponibles = data.promociones;
            
            if (promocionesDisponibles.length > 0) {
                document.getElementById('promociones-section').style.display = 'block';
                mostrarPromocionesDisponibles();
                actualizarSelectPromociones();
            } else {
                document.getElementById('promociones-section').style.display = 'none';
            }
        })
        .catch(error => console.error('Error al cargar promociones:', error));
}

function mostrarPromocionesDisponibles() {
    const container = document.getElementById('lista-promociones');
    
    if (promocionesDisponibles.length === 0) {
        container.innerHTML = '<p class="text-muted">No hay promociones disponibles para este servicio.</p>';
        return;
    }
    
    let html = '<div style="margin-top: 15px;"><strong>Promociones disponibles:</strong></div>';
    
    promocionesDisponibles.forEach(promo => {
        html += `
            <div class="promocion-card" data-promocion-id="${promo.id}">
                <div class="promocion-titulo">${promo.titulo}</div>
                <div class="promocion-descripcion">${promo.descripcion}</div>
                <div class="promocion-detalles">
                    <div class="promocion-descuento">
                        -$${promo.descuento_calculado.toFixed(2)} (${promo.tipo_descuento})
                    </div>
                    <div class="promocion-precio">
                        <span class="precio-tachado">$${precioBase.toFixed(2)}</span>
                        <span class="precio-final">$${promo.precio_final.toFixed(2)}</span>
                    </div>
                </div>
                ${promo.codigo ? `<div style="margin-top: 8px; font-size: 0.9em; color: #666;"><i class="fas fa-tag"></i> C√≥digo: <strong>${promo.codigo}</strong></div>` : ''}
            </div>
        `;
    });
    
    container.innerHTML = html;
    
    // Agregar eventos de click
    document.querySelectorAll('.promocion-card').forEach(card => {
        card.addEventListener('click', function() {
            seleccionarPromocion(this.dataset.promocionId);
        });
    });
}

function actualizarSelectPromociones() {
    const select = document.getElementById('id_promocion');
    
    // Limpiar opciones existentes excepto la primera
    while (select.options.length > 1) {
        select.remove(1);
    }
    
    // Agregar nuevas opciones
    promocionesDisponibles.forEach(promo => {
        const option = document.createElement('option');
        option.value = promo.id;
        option.textContent = `${promo.titulo} - Ahorr√° $${promo.descuento_calculado.toFixed(2)}`;
        select.appendChild(option);
    });
    
    if (promocionesDisponibles.length > 0) {
        document.getElementById('promociones-disponibles-group').style.display = 'block';
    }
}

function seleccionarPromocion(promocionId) {
    // Actualizar cards visuales
    document.querySelectorAll('.promocion-card').forEach(card => {
        card.classList.remove('seleccionada');
    });
    
    const cardSeleccionada = document.querySelector(`[data-promocion-id="${promocionId}"]`);
    if (cardSeleccionada) {
        cardSeleccionada.classList.add('seleccionada');
    }
    
    // Actualizar select
    document.getElementById('id_promocion').value = promocionId;
    
    // Actualizar resumen
    const promo = promocionesDisponibles.find(p => p.id == promocionId);
    if (promo) {
        document.getElementById('resumen-descuento').textContent = `-$${promo.descuento_calculado.toFixed(2)}`;
        document.getElementById('resumen-total').textContent = `$${promo.precio_final.toFixed(2)}`;
        document.getElementById('resumen-descuento-item').style.display = 'flex';
        document.getElementById('resumen-total-item').style.display = 'flex';
    }
}

// Evento para validar c√≥digo promocional
document.getElementById('btnValidarCodigo').addEventListener('click', function() {
    const codigo = document.getElementById('id_codigo_promocion').value.trim();
    
    if (!codigo) {
        mostrarMensajeCodigo('Ingrese un c√≥digo promocional', 'error');
        return;
    }
    
    if (!servicioSeleccionado) {
        mostrarMensajeCodigo('Seleccione un servicio primero', 'error');
        return;
    }
    
    fetch(`{% url 'turnos:validar_codigo_promocional' %}?codigo=${encodeURIComponent(codigo)}&servicio_id=${servicioSeleccionado.id}`)
        .then(response => response.json())
        .then(data => {
            if (data.valido) {
                mostrarMensajeCodigo(data.mensaje, 'success');
                
                // Actualizar resumen con la promoci√≥n del c√≥digo
                document.getElementById('resumen-descuento').textContent = `-$${data.promocion.descuento.toFixed(2)}`;
                document.getElementById('resumen-total').textContent = `$${data.promocion.precio_final.toFixed(2)}`;
                document.getElementById('resumen-descuento-item').style.display = 'flex';
                document.getElementById('resumen-total-item').style.display = 'flex';
                
                // Limpiar selecci√≥n de promociones visuales
                document.querySelectorAll('.promocion-card').forEach(card => {
                    card.classList.remove('seleccionada');
                });
                document.getElementById('id_promocion').value = '';
            } else {
                mostrarMensajeCodigo(data.mensaje, 'error');
                document.getElementById('resumen-descuento-item').style.display = 'none';
                document.getElementById('resumen-total-item').style.display = 'none';
            }
        })
        .catch(error => {
            mostrarMensajeCodigo('Error al validar el c√≥digo', 'error');
            console.error('Error:', error);
        });
});

function mostrarMensajeCodigo(mensaje, tipo) {
    const div = document.getElementById('mensaje-codigo');
    div.textContent = mensaje;
    div.className = tipo;
    div.style.display = 'block';
    
    // Ocultar despu√©s de 5 segundos
    setTimeout(() => {
        div.style.display = 'none';
    }, 5000);
}

// Evento para cambio en el select de promociones
document.getElementById('id_promocion').addEventListener('change', function() {
    const promocionId = this.value;
    
    if (promocionId) {
        seleccionarPromocion(promocionId);
        // Limpiar c√≥digo promocional
        document.getElementById('id_codigo_promocion').value = '';
        document.getElementById('mensaje-codigo').style.display = 'none';
    } else {
        // Sin promoci√≥n seleccionada
        document.querySelectorAll('.promocion-card').forEach(card => {
            card.classList.remove('seleccionada');
        });
        document.getElementById('resumen-descuento-item').style.display = 'none';
        document.getElementById('resumen-total-item').style.display = 'none';
    }
});

document.getElementById('turnoForm').addEventListener('submit', function(e) {
    if (!servicioSeleccionado || !profesionalSeleccionado || !horarioSeleccionado) {
        e.preventDefault();
        alert('Complete todos los pasos');
        return false;
    }
    
    const direccion = document.getElementById('id_direccion').value;
    if (!direccion || direccion.trim() === '') {
        e.preventDefault();
        alert('Seleccione una ubicaci√≥n en el mapa');
        return false;
    }
});

window.onload = initMap;
</script>
{% endblock %}
